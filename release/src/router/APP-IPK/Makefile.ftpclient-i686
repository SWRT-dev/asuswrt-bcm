CURRENT=..
SEP=echo "\033[41;1m   $@   \033[0m"
export SRCBASE := $(shell cd ../;pwd)
export BUILD := $(shell (gcc -dumpmachine))
export HOSTCC := gcc
export PLATFORM := i686-cm-linux
CROSS_COMPILE := i686-cm-linux-
export CROSS_COMPILER := $(CROSS_COMPILE)
export CONFIGURE := ./configure --host=i686-cm-linux --build=$(BUILD)
export TOOLCHAIN := $(shell cd $(dir $(shell which $(CROSS_COMPILE)gcc))/.. && pwd)
export IPKG_TOOLS := ~/toolchain/ipkg-utils-1.7
#export LD_DIR := $(shell cd $(dir $(shell which $(CROSS_COMPILE)gcc))/../../../../staging && pwd)
export LD_DIR := $(TOOLCHAIN)

export CC := $(CROSS_COMPILE)gcc
export AR := $(CROSS_COMPILE)ar
export AS := $(CROSS_COMPILE)as
export LD := $(CROSS_COMPILE)ld
export NM := $(CROSS_COMPILE)nm
export RANLIB := $(CROSS_COMPILE)ranlib
export STRIP := $(CROSS_COMPILE)strip
export SIZE := $(CROSS_COMPILE)size
export CXX := $(CROSS_COMPILE)g++
export CXXCPP := $(CROSS_COMPILE)g++ -E

obj-y += mkdir
obj-y += zlib
obj-y += libxml
obj-y += openssl
obj-y += curl
obj-y += libiconv-1.14
obj-y += ftpclient
obj-y += ftpclient-ipk

all: $(obj-y)
	echo $(LD_DIR)
	echo $(TOOLCHAIN)
	echo $(IPKG_TOOLS)

clean:
	@$(MAKE) -C $(CURRENT)/ftpclient clean -f Makefile.ipk
	@$(MAKE) -C $(CURRENT)/libxml2 clean
	@$(MAKE) -C $(CURRENT)/openssl-ipk clean
	@$(MAKE) -C $(CURRENT)/zlib clean
	@$(MAKE) -C $(CURRENT)/curl-7.21.7 clean
	@$(MAKE) -C $(CURRENT)/libiconv-1.14 clean
	@rm -rf Ftpclient-ipk/opt/tmp/bin/*
	rm -rf ftpclient_*.ipk

mkdir:
	-mkdir -p Ftpclient-ipk/opt/tmp/bin/

zlib/stamp-h1: 
		@$(SEP)
		cd $(CURRENT)/zlib \
		touch stamp-h1;	

zlib: zlib/stamp-h1
	cd $(CURRENT)/zlib && \
	AR=$(AR) AS=$(AS) LD=$(LD) NM=$(NM) CC=$(CC) CPP="$(CC) -E" GCC=$(CC) CXX=$(CXX) RANLIB=$(RANLIB) STRIP=$(STRIP) \
		prefix=$(SRCBASE)/opt \
		./configure \
		--shared
	@$(MAKE) -C  $(CURRENT)/zlib all
	cd $(CURRENT)/zlib && \
	$(MAKE) install

libxml2/stamp-h1: 
		@$(SEP)
		cd $(CURRENT)/libxml2 \
		touch stamp-h1;	

libxml: libxml2/stamp-h1
	cd $(CURRENT)/libxml2 && autoreconf -i -f && \
	AR=$(AR) AS=$(AS) LD=$(LD) NM=$(NM) CC=$(CC) CPP="$(CC) -E" GCC=$(CC) CXX=$(CXX) RANLIB=$(RANLIB) STRIP=$(STRIP) CPPFLAGS="-O2   -pipe  -I$(SRCBASE)/opt/include " LDFLAGS=" -L$(SRCBASE)/opt/lib -Wl,-rpath,/opt/lib -Wl,-rpath-link,$(SRCBASE)/opt/lib " \
	./configure --build=i386-pc-linux-gnu --host=i686-cm-linux --target=i686-cm-linux --prefix=$(SRCBASE)/opt --without-python --disable-dependency-tracking --without-zlib
	@$(MAKE) -C $(CURRENT)/libxml2 all
	cd $(CURRENT)/libxml2 && \
	$(MAKE) install
	#cp -rf libxml2-2.7.8/.libs/libxml2.so.2.7.8 Aicloud-pkg-0.1/opt/tmp/lib/


openssl/stamp-h1: 
		cd $(CURRENT)/openssl-ipk \
		touch stamp-h1;	


openssl: openssl/stamp-h1
	cd $(CURRENT)/openssl-ipk && \
	AR=$(AR) AS=$(AS) LD=$(LD) NM=$(NM) CC=$(CC) CPP="$(CC) -E" GCC=$(CC) CXX=$(CXX) RANLIB=$(RANLIB) STRIP=$(STRIP) \
	./Configure shared no-zlib -O2   -pipe  -I$(SRCBASE)/opt/include --openssldir=$(SRCBASE)/opt/share/openssl --prefix=$(SRCBASE)/opt linux-generic32 
	@$(MAKE) -C $(CURRENT)/openssl-ipk
	cd $(CURRENT)/openssl-ipk && \
	$(MAKE) install

curl/stamp-h1: 
		@$(SEP)
		cd $(CURRENT)/curl-7.21.7 \
		touch stamp-h1;	

curl: curl/stamp-h1
	cd $(CURRENT)/curl-7.21.7 && \
	AR=$(AR) AS=$(AS) LD=$(LD) NM=$(NM) CC=$(CC) CPP="$(CC) -E" GCC=$(CC) CXX=$(CXX) RANLIB=$(RANLIB) STRIP=$(STRIP) \
	./configure --build=i386-pc-linux-gnu --host=i686-cm-linux --target=i686-cm-linux --prefix=$(SRCBASE)/opt --enable-http --with-ssl=$(SRCBASE)/openssl-ipk
	@$(MAKE) -C $(CURRENT)/curl-7.21.7
	cd $(CURRENT)/curl-7.21.7 && \
	$(MAKE) install

libiconv-1.14/stamp-h1:
	@$(SEP)
	cd $(CURRENT)/libiconv-1.14 && \
	touch stamp-h1

libiconv-1.14:libiconv-1.14/stamp-h1
	cd $(CURRENT)/libiconv-1.14 && \
	AR=$(AR) AS=$(AS) LD=$(LD) NM=$(NM) CC=$(CC) CPP="$(CC) -E" GCC=$(CC) CXX=$(CXX) RANLIB=$(RANLIB) STRIP=$(STRIP) \
	./configure --build=i386-pc-linux-gnu --host=i686-cm-linux --target=i686-cm-linux --prefix=$(SRCBASE)/opt
	@$(MAKE) -C $(CURRENT)/libiconv-1.14
	cd $(CURRENT)/libiconv-1.14 && \
	$(MAKE) install

libiconv-1.14-clean:
	-@$(MAKE) -C $(CURRENT)/libiconv-1.14 clean
	@rm -f $(CURRENT)/libiconv-1.14/stamp-h1

ftpclient-clean:
	@$(MAKE) -C $(CURRENT)/ftpclient clean -f Makefile.ipk
	rm -rf $(CURRENT)/ftpclient/stamp-h1

ftpclient/stamp-h1:
	cd $(CURRENT)/ftpclient
	touch stamp-h1

ftpclient: ftpclient/stamp-h1
	@$(SEP)
	@$(MAKE) -C $(CURRENT)/ftpclient -f Makefile.ipk I686_D=1
	cp -rf $(CURRENT)/ftpclient/ftpclient Ftpclient-ipk/opt/tmp/bin/



ftpclient-ipk:
	cp -rf AiCloud-tmp/CONTROL/control-ftp-i686 Ftpclient-ipk/CONTROL/control
	$(STRIP) Ftpclient-ipk/opt/tmp/bin/*
	#$(STRIP) Ftpclient-ipk/opt/tmp/lib/*
	@$(IPKG_TOOLS)/ipkg-build Ftpclient-ipk ./
